#
# spec file for package oss-base
#
# Copyright (c) Peter Varkoly, Nuernberg, Germany.
#
# All modifications and additions to the file contributed by third parties
# remain the property of their copyright owners, unless otherwise agreed
# upon. 

# Please submit bugfixes or comments via http://www.cephalix.eu/
#

%define python_flavor python3
if !%defined %{python_sitearch}
%define python_sitearch  /usr/lib64/python3.6/site-packages/
%endif
Name:           oss-base
Version:        @VERSION@
Release:        @RELEASE@ 
License:        GPL-3.0+
Vendor:         Dipl.Ing. Peter Varkoly <peter@varkoly.de>
Summary:        Base package for the CRANIX/OSS
Url:            http://oss.cephalix.eu/
Group:          Productivity/Office/Management
Source:         %{name}.tar.bz2
BuildArch:      noarch
PreReq:         cups
PreReq:         salt
PreReq:         salt-master
PreReq:         filesystem
PreReq:         firewalld
PreReq:         apache2
Requires:       acl
Requires:       quota
Requires:       rsync
Requires:       python3-xhtml2pdf
Requires:       samba-ad >= 4.10.0
Requires:       python3-configobj
Requires:       perl-JSON-XS
Requires:       perl-Mail-IMAPClient
Requires:       perl-DBD-mysql
Requires:       poppler-tools
#On oss some packages must not be installed
Conflicts:      nscd
Conflicts:      yast2-samba-server
Conflicts:      yast2-dns-server
Conflicts:      yast2-dhcp-server

BuildRequires:  rsync
BuildRequires:  python-rpm-macros
BuildRequires:  -post-build-checks
BuildRoot:      %{_tmppath}/%{name}-%{version}-build

Provides:       openschool-base
Obsoletes:      openschool-base

%prep
%setup -q  -n %{name}

%build

%install
make install DESTDIR=%{buildroot} FILLUPDIR=%{_fillupdir} PYTHONSITEARCH=%{python_sitearch}

%pre
%service_add_pre oss_salt_event_watcher.service

%preun
%service_del_preun oss_salt_event_watcher.service

%post
%service_add_post oss_salt_event_watcher.service
if [ ${1:-0} -gt 1 ]; then
   echo "Executing Update Scripts"
   mkdir -p /var/adm/oss
   mkdir -p /var/log/oss-update
   UV=$( echo %{version} | sed -r 's/(...)../\1/' )
   for i in /usr/share/oss/updates/update-$UV-*
   do
       if [ -e $i ]; then
            b=$(basename $i)
            $i &> /var/log/oss-update/$b
       fi
   done
   if [ ! -e /usr/share/oss/templates/password.html ]; then
      . /etc/sysconfig/schoolserver
      sed "s/SCHOOLNAME/$SCHOOL_NAME/" /usr/share/oss/templates/password.html.in > /usr/share/oss/templates/password.html
   fi
else
   #Set German as default language
   . etc/sysconfig/language
   if [ -z ${RC_LANG} ]; then
      sed -i 's/^RC_LANG=.*/RC_LANG="de_DE.UTF-8"/' etc/sysconfig/language
   fi
fi
if [ -e /usr/share/oss/software/oss ]; then
        rsync -av /usr/share/oss/software/oss/ /home/software/oss/
fi
if [ -e /usr/share/oss/profiles ]; then
        rsync -av /usr/share/oss/profiles/     /home/profiles/oss/
fi

sed -i 's/#.*solver.allowVendorChange.*$/solver.allowVendorChange = true/' /etc/zypp/zypp.conf

%{fillup_only -n schoolserver}

%postun
%service_del_postun oss_salt_event_watcher.service

%files
%defattr(-,root,root)
/etc/cups/cupsd.conf.in
%dir    /etc/skel/Desktop
%dir    /etc/YaST2
%config /etc/YaST2/oss-firstboot.xml
%config /etc/my.cnf.in
%dir    /etc/cron.hourly
%config /etc/cron.hourly/oss.*
%config /etc/cron.daily/oss*
%config(noreplace) /etc/cron.d/oss*
%config /etc/salt/master.d/oss.conf
%config /etc/skel/Desktop/*
%dir    /etc/apache2/vhosts.d/oss
/etc/apache2/vhosts.d/oss/public_html_*
/usr/share/oss/
/usr/sbin/oss*
/usr/lib/systemd/system/oss_*.service
%dir /usr/share/cups/drivers/x64/
%dir /usr/share/cups/ipptool/
%dir /usr/share/cups/ipptool/
%dir /usr/share/cups/
/usr/share/cups/ipptool/*
/usr/share/cups/drivers/ps*
/usr/share/cups/drivers/x64/ps*
/usr/lib/firewalld/services/*
%{python_sitearch}/cranix
%{_fillupdir}/sysconfig.schoolserver
%dir /srv/salt/_modules
/srv/salt/_modules/*
/usr/lib/firewalld/services/*
%doc README.md

%description
This package contains the basic utilitis to setup configure and manage the OSS base system.

Authors:
--------
        peter@varkoly.de

ChangeLog:
---------

